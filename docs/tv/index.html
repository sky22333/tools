<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVBox é…ç½®ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        /* Shadcn UI Color Variables */
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }

        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 210 40% 98%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
        }
        
        /* Utility for transitions */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: hsl(var(--muted-foreground) / 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--muted-foreground) / 0.5);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: {
                    center: true,
                    padding: "2rem",
                    screens: {
                        "2xl": "1400px",
                    },
                },
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    keyframes: {
                        "accordion-down": {
                            from: { height: 0 },
                            to: { height: "var(--radix-accordion-content-height)" },
                        },
                        "accordion-up": {
                            from: { height: "var(--radix-accordion-content-height)" },
                            to: { height: 0 },
                        },
                    },
                    animation: {
                        "accordion-down": "accordion-down 0.2s ease-out",
                        "accordion-up": "accordion-up 0.2s ease-out",
                    },
                },
            },
        }
    </script>
</head>
<body class="antialiased min-h-screen bg-slate-50 dark:bg-slate-950">
    <div id="app" class="p-4 md:p-8 max-w-[1600px] mx-auto">
        
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight flex items-center gap-2">
                    <i data-lucide="tv" class="w-8 h-8 text-primary"></i>
                    TVBox é…ç½®ç”Ÿæˆå™¨
                </h1>
                <p class="text-muted-foreground mt-2">
                    ç°ä»£åŒ–ã€å“åº”å¼çš„ TVBox JSON é…ç½®æ–‡ä»¶ç”Ÿæˆå·¥å…·ã€‚æ”¯æŒå®æ—¶é¢„è§ˆä¸ Base64 å¯¼å‡ºã€‚
                </p>
            </div>
            <div class="flex gap-2">
                <button @click="toggleDarkMode" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10">
                    <i :data-lucide="isDark ? 'sun' : 'moon'" class="w-5 h-5"></i>
                </button>
                <a href="https://github.com/sky22333/tools" target="_blank" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 gap-2">
                    <i data-lucide="github" class="w-4 h-4"></i>
                    GitHub
                </a>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Panel: Configuration Form -->
            <div class="space-y-6">
                
                <!-- Global Settings -->
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="text-2xl font-semibold leading-none tracking-tight">å…¨å±€è®¾ç½®</h3>
                        <p class="text-sm text-muted-foreground">é…ç½®å…¨å±€å‚æ•°ï¼Œå¦‚çˆ¬è™« Jar åŒ…å’ŒèƒŒæ™¯å›¾ç‰‡ã€‚</p>
                    </div>
                    <div class="p-6 pt-0 space-y-4">
                        <div class="grid gap-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                çˆ¬è™« Jar åŒ…åœ°å€ (Spider)
                            </label>
                            <input v-model="config.spider" type="text" placeholder="ä¾‹å¦‚: ./custom_spider.jar æˆ– http://..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                        <div class="grid gap-2">
                            <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                èƒŒæ™¯å›¾ç‰‡åœ°å€ (Wallpaper)
                            </label>
                            <input v-model="config.wallpaper" type="text" placeholder="ä¾‹å¦‚: https://api.kdcc.cn" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                    </div>
                </div>

                <!-- Sites Configuration -->
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <div class="flex items-center justify-between gap-4">
                            <div class="min-w-0">
                                <h3 class="text-2xl font-semibold leading-none tracking-tight">è§†é¢‘æº (Sites)</h3>
                                <p class="text-sm text-muted-foreground mt-1">æ·»åŠ  è‹¹æœCMS v10 æˆ–å…¶ä»–ç±»å‹çš„è§†é¢‘æºæ¥å£ã€‚</p>
                            </div>
                            <button @click="addSite" class="shrink-0 whitespace-nowrap inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2 gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢æº
                            </button>
                        </div>
                    </div>
                    <div class="p-6 pt-0 space-y-4">
                        <transition-group name="fade" tag="div" class="space-y-4">
                            <div v-for="(site, index) in config.sites" :key="index" class="group relative grid gap-4 rounded-md border p-4 hover:bg-accent/50 transition-colors">
                                <div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                    <button @click="removeSite(index)" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 hover:bg-destructive hover:text-destructive-foreground h-8 w-8">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="grid gap-2">
                                    <label class="text-sm font-medium leading-none">æºåç§°</label>
                                    <input v-model="site.name" type="text" placeholder="ä¾‹å¦‚: ğŸ¬æˆ‘çš„è§†é¢‘æº" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                </div>
                                <div class="grid gap-2">
                                    <label class="text-sm font-medium leading-none">API æ¥å£åœ°å€</label>
                                    <input v-model="site.api" type="text" placeholder="ä¾‹å¦‚: https://example.com/api.php/provide/vod" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                </div>
                                <div class="flex items-center gap-4 text-xs text-muted-foreground">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" v-model="site.searchable" :true-value="1" :false-value="0" class="rounded border-gray-300 text-primary focus:ring-primary">
                                        å¯æœç´¢
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" v-model="site.quickSearch" :true-value="1" :false-value="0" class="rounded border-gray-300 text-primary focus:ring-primary">
                                        å¿«é€Ÿæœç´¢
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" v-model="site.filterable" :true-value="1" :false-value="0" class="rounded border-gray-300 text-primary focus:ring-primary">
                                        å¯ç­›é€‰
                                    </label>
                                </div>
                            </div>
                        </transition-group>
                        
                        <div v-if="config.sites.length === 0" class="text-center py-8 text-muted-foreground border-2 border-dashed rounded-md">
                            æš‚æ— è§†é¢‘æºï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ–°å¢æºâ€
                        </div>
                    </div>
                </div>

                <!-- Parses Configuration -->
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <div class="flex items-center justify-between gap-4">
                            <div class="min-w-0">
                                <h3 class="text-2xl font-semibold leading-none tracking-tight">è§£ææ¥å£ (Parses)</h3>
                                <p class="text-sm text-muted-foreground mt-1">é…ç½®è§†é¢‘èšåˆè§£ææ¥å£ï¼Œè‡ªåŠ¨ç”Ÿæˆå¸¸è§ Flagã€‚</p>
                            </div>
                            <button @click="addParse" class="shrink-0 whitespace-nowrap inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2 gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢è§£æ
                            </button>
                        </div>
                    </div>
                    <div class="p-6 pt-0 space-y-4">
                         <transition-group name="fade" tag="div" class="space-y-4">
                            <div v-for="(parse, index) in config.parses" :key="index" class="group relative grid gap-4 rounded-md border p-4 hover:bg-accent/50 transition-colors">
                                <div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                    <button @click="removeParse(index)" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 hover:bg-destructive hover:text-destructive-foreground h-8 w-8">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="grid gap-2">
                                    <label class="text-sm font-medium leading-none">è§£æåç§°</label>
                                    <input v-model="parse.name" type="text" placeholder="ä¾‹å¦‚: èšåˆè§£æ" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                </div>
                                <div class="grid gap-2">
                                    <label class="text-sm font-medium leading-none">è§£æ URL</label>
                                    <input v-model="parse.url" type="text" placeholder="ä¾‹å¦‚: https://jx.example.com/?url=" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                </div>
                                <div class="grid gap-2">
                                    <label class="text-sm font-medium leading-none">å¹³å°æ ‡è¯† (Flags)</label>
                                    <input :value="parse.ext.flag.join(', ')" @input="updateFlags(index, $event.target.value)" type="text" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: qq, youku, qiyi" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                    <p class="text-xs text-muted-foreground">é»˜è®¤åŒ…å«: youku, qq, iqiyi, qiyi, letv, sohu, tudou, pptv, mgtv, wasu</p>
                                </div>
                            </div>
                        </transition-group>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Preview & Actions -->
            <div class="lg:sticky lg:top-8 h-fit space-y-6">
                
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="text-2xl font-semibold leading-none tracking-tight">é…ç½®é¢„è§ˆ</h3>
                        <p class="text-sm text-muted-foreground">å®æ—¶ç”Ÿæˆçš„ JSON é…ç½®ä»£ç ã€‚</p>
                    </div>
                    <div class="p-6 pt-0">
                        <div class="relative group">
                            <textarea 
                                v-model="internalJson"
                                @focus="onEditorFocus"
                                @blur="onEditorBlur"
                                @keydown.tab.prevent="handleTab"
                                spellcheck="false"
                                class="flex w-full rounded-md border border-input bg-muted px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 overflow-auto h-[500px] font-mono text-xs leading-5 resize-none"
                            ></textarea>
                            
                            <!-- Error Message -->
                            <div v-if="jsonError" class="absolute bottom-4 left-4 right-4 bg-destructive/90 text-destructive-foreground px-4 py-2 rounded-md text-xs font-mono backdrop-blur-sm animate-in fade-in slide-in-from-bottom-2 pointer-events-none">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                    <span>{{ jsonError }}</span>
                                </div>
                            </div>

                            <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="copyJson" class="inline-flex items-center justify-center rounded-md text-xs font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-secondary text-secondary-foreground hover:bg-secondary/80 h-8 px-3 border shadow-sm">
                                    <i data-lucide="copy" class="w-3 h-3 mr-1"></i> {{ copyText }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 pt-0 flex flex-col gap-3">
                        <button @click="downloadJson" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> ä¸‹è½½ .json æ–‡ä»¶
                        </button>
                        
                        <div class="grid grid-cols-2 gap-3">
                             <button @click="showBase64Modal = true" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                                <i data-lucide="file-code" class="w-4 h-4 mr-2"></i> Base64 ç¼–ç 
                            </button>
                             <button @click="resetConfig" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-destructive hover:text-destructive-foreground h-10 px-4 py-2">
                                <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i> é‡ç½®é…ç½®
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
        
        <!-- Base64 Modal -->
        <div v-if="showBase64Modal" @click.self="showBase64Modal = false" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
             <div class="rounded-lg border bg-background p-6 shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Base64 ç¼–ç ç»“æœ</h3>
                    <button @click="showBase64Modal = false" class="rounded-full p-1 hover:bg-accent">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="grid gap-2">
                        <div class="flex gap-2 items-center">
                            <input :value="base64Output" readonly class="flex-1 flex h-9 rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                            <button @click="copyTextToClipboard(base64Output)" class="shrink-0 whitespace-nowrap inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 px-3">
                                å¤åˆ¶
                            </button>
                        </div>
                    </div>
                </div>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                // Default Flags
                const defaultFlags = [
                    "youku", "qq", "iqiyi", "qiyi", "letv", 
                    "sohu", "tudou", "pptv", "mgtv", "wasu"
                ];

                // Initial Config State
                const config = ref({
                    spider: "",
                    wallpaper: "https://api.kdcc.cn",
                    sites: [
                        { key: "demo_site", name: "ğŸ¬ ç¤ºä¾‹æº", type: 1, api: "https://example.com/api.php/provide/vod", searchable: 1, quickSearch: 1, filterable: 1 }
                    ],
                    parses: [
                         { name: "èšåˆè§£æ", type: 0, url: "https://example.com/?url=", ext: { flag: [...defaultFlags] } }
                    ]
                });

                // UI State
                const copyText = ref("å¤åˆ¶ JSON");
                const showBase64Modal = ref(false);
                const isDark = ref(false);
                
                // Editor State
                const internalJson = ref("");
                const isFocused = ref(false);
                const jsonError = ref(null);

                // Helper: Process Config to ensure keys exist
                const getProcessedConfig = (cfg) => {
                    const processedSites = cfg.sites.map((site, idx) => ({
                        ...site,
                        key: site.key || `site_${idx}_${Date.now()}`
                    }));
                    return {
                        ...cfg,
                        sites: processedSites
                    };
                };

                // Sync Config -> JSON
                watch(config, (newVal) => {
                    if (!isFocused.value) {
                        const finalConfig = getProcessedConfig(newVal);
                        internalJson.value = JSON.stringify(finalConfig, null, 2);
                        jsonError.value = null; // Clear error on external update
                    }
                }, { deep: true, immediate: true });

                // Sync JSON -> Config (Debounced or on input)
                watch(internalJson, (newVal) => {
                    if (!newVal) return;
                    
                    try {
                        const parsed = JSON.parse(newVal);
                        // Basic validation
                        if (typeof parsed !== 'object' || parsed === null) {
                            throw new Error("JSON must be an object");
                        }
                        
                        // Update config silently (without triggering reverse watch loop ideally, 
                        // but logic handles it via !isFocused check mostly, though deep watch might still trigger.
                        // However, if parsed object is structurally same as config, vue might skip update?
                        // Actually, since we update config, the watch(config) will trigger.
                        // But if isFocused is true, it won't overwrite internalJson. Perfect.
                        
                        config.value = parsed;
                        jsonError.value = null;
                    } catch (e) {
                        jsonError.value = e.message;
                    }
                });

                // Computed for exports (referencing internalJson to reflect current editor state)
                const jsonOutput = computed(() => internalJson.value);
                
                // Computed Base64 Output
                const base64Output = computed(() => {
                    try {
                        // Use standard btoa with UTF-8 encoding fix
                        const str = jsonOutput.value;
                        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                            function toSolidBytes(match, p1) {
                                return String.fromCharCode('0x' + p1);
                        }));
                    } catch (e) {
                        return "Error generating Base64";
                    }
                });

                // Editor Methods
                const onEditorFocus = () => {
                    isFocused.value = true;
                };

                const onEditorBlur = () => {
                    isFocused.value = false;
                    // Re-format on blur if valid
                    if (!jsonError.value) {
                        const finalConfig = getProcessedConfig(config.value);
                        internalJson.value = JSON.stringify(finalConfig, null, 2);
                    }
                };

                const handleTab = (e) => {
                    const textarea = e.target;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    
                    // Insert 2 spaces
                    const spaces = "  ";
                    internalJson.value = internalJson.value.substring(0, start) + spaces + internalJson.value.substring(end);
                    
                    // Move cursor
                    nextTick(() => {
                        textarea.selectionStart = textarea.selectionEnd = start + spaces.length;
                    });
                };

                // Methods
                const addSite = () => {
                    config.value.sites.push({
                        key: "",
                        name: "",
                        type: 1,
                        api: "",
                        searchable: 1,
                        quickSearch: 1,
                        filterable: 1
                    });
                };

                const removeSite = (index) => {
                    config.value.sites.splice(index, 1);
                };

                const addParse = () => {
                    config.value.parses.push({
                        name: "æ–°è§£ææ¥å£",
                        type: 0,
                        url: "",
                        ext: { flag: [...defaultFlags] }
                    });
                };

                const removeParse = (index) => {
                    config.value.parses.splice(index, 1);
                };

                const updateFlags = (index, value) => {
                    // Split by comma and trim
                    const flags = value.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s);
                    config.value.parses[index].ext.flag = flags;
                };

                const copyJson = () => {
                    navigator.clipboard.writeText(jsonOutput.value).then(() => {
                        copyText.value = "å·²å¤åˆ¶!";
                        setTimeout(() => copyText.value = "å¤åˆ¶ JSON", 2000);
                    });
                };
                
                const copyTextToClipboard = (text) => {
                     navigator.clipboard.writeText(text).then(() => {
                        alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
                    });
                }

                const downloadJson = () => {
                    const blob = new Blob([jsonOutput.value], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "tvbox.json";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
                
                const resetConfig = () => {
                    if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ")) {
                        config.value = {
                            spider: "",
                            wallpaper: "https://api.kdcc.cn",
                            sites: [],
                            parses: []
                        };
                        addSite(); // Add one empty site
                        addParse(); // Add one default parse
                    }
                };
                
                const toggleDarkMode = () => {
                    isDark.value = !isDark.value;
                    if (isDark.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };

                // Watchers for Lucide icons updates
                watch(() => [config.value.sites.length, config.value.parses.length, showBase64Modal.value], () => {
                    nextTick(() => {
                        lucide.createIcons();
                    });
                });

                onMounted(() => {
                    lucide.createIcons();
                    // Check system preference for dark mode
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        isDark.value = true;
                        document.documentElement.classList.add('dark');
                    }
                });

                return {
                    config,
                    jsonOutput,
                    base64Output,
                    copyText,
                    showBase64Modal,
                    isDark,
                    addSite,
                    removeSite,
                    addParse,
                    removeParse,
                    updateFlags,
                    copyJson,
                    copyTextToClipboard,
                    downloadJson,
                    resetConfig,
                    toggleDarkMode,
                    internalJson,
                    jsonError,
                    onEditorFocus,
                    onEditorBlur,
                    handleTab
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
