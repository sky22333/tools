<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具导航站</title>
    <link rel="icon" href="favicon.ico">
    <link rel="preconnect" href="https://www.google.com">
    <link rel="preconnect" href="https://icons.duckduckgo.com">
    <link rel="preconnect" href="https://unavatar.io">
    <link rel="preload" href="sites.txt" as="fetch" crossorigin>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: {
                    center: true,
                    padding: "2rem",
                    screens: {
                        "2xl": "1400px",
                    },
                },
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 240 10% 3.9%;
                --card: 0 0% 100%;
                --card-foreground: 240 10% 3.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 240 10% 3.9%;
                --primary: 240 5.9% 10%;
                --primary-foreground: 0 0% 98%;
                --secondary: 240 4.8% 95.9%;
                --secondary-foreground: 240 5.9% 10%;
                --muted: 240 4.8% 95.9%;
                --muted-foreground: 240 3.8% 46.1%;
                --accent: 240 4.8% 95.9%;
                --accent-foreground: 240 5.9% 10%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 0 0% 98%;
                --border: 240 5.9% 90%;
                --input: 240 5.9% 90%;
                --ring: 240 5.9% 10%;
                --radius: 0.5rem;
            }
            html, body {
                overflow-x: hidden;
            }
        }
        
        /* Custom Scrollbar for Menu */
        .custom-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .custom-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Sidebar navigation styles (desktop) */
        .nav-item {
            position: relative;
            display: flex;
            width: 100%;
            align-items: center;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.9375rem;
            color: hsl(var(--muted-foreground));
            transition: all 0.2s ease-in-out;
            line-height: 1.25rem;
        }
        .nav-item:hover {
            background-color: hsl(var(--muted));
            color: hsl(var(--foreground));
            border-color: hsl(var(--border));
        }
        .nav-item.active {
            background-color: hsl(var(--secondary));
            color: hsl(var(--foreground));
            font-weight: 600;
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 1.5rem;
            width: 3px;
            background-color: hsl(var(--primary));
            border-radius: 0 2px 2px 0;
        }
        
        /* Desktop layout: convert floating menu to left sidebar */
        @media (min-width: 768px) {
            #fabContainer {
                position: fixed;
                top: 64px; /* header height */
                left: 0;
                bottom: 0;
                width: 240px;
                z-index: 40;
                display: flex;
                flex-direction: column;
                align-items: stretch;
                pointer-events: auto;
                background-color: hsl(var(--card));
                border-right: 1px solid hsl(var(--border));
            }
            #fabBtn {
                display: none !important;
            }
            #categoryMenu {
                margin-bottom: 0;
                width: 100%;
                height: calc(100vh - 64px);
                max-height: none;
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                scale: 1 !important;
                translate: none !important;
                border-left: none;
                border-top: none;
                border-bottom: none;
                box-shadow: none;
                background-color: transparent;
                border-radius: 0;
            }
            #categoryMenuList {
                flex: 1;
                overflow-y: auto;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            header .container {
                max-width: none;
                padding-left: 1rem;
            }
            main.container {
                margin-left: 260px; /* reserve space for sidebar */
                padding-top: 1rem;
            }
        }

        /* Mobile dropdown positioning */
        @media (max-width: 767px) {
            #fabContainer {
                top: calc(64px + 0.5rem);
                right: max(1rem, env(safe-area-inset-right));
                left: 1rem;
                bottom: auto;
                align-items: flex-end;
                width: auto;
            }
            #categoryMenu {
                width: clamp(200px, 72vw, 240px);
                max-width: calc(100vw - 2rem);
                height: calc(100svh - 80px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                max-height: calc(100svh - 80px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin-bottom: 0;
                transform-origin: top right;
                box-sizing: border-box;
            }
            #categoryMenuList { flex: 1; overflow-y: auto; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50">
        <div class="container mx-auto max-w-6xl px-4 md:px-6 flex h-16 items-center justify-between">
            <div class="flex gap-2 items-center font-bold text-xl">
                <i data-lucide="layout-grid" class="h-6 w-6"></i>
                <span>Nav</span>
            </div>
            <div class="flex items-center gap-1 md:gap-2">
                <nav class="flex items-center space-x-1">
                    <a href="https://github.com/sky22333/tools" target="_blank" rel="noreferrer" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-accent hover:text-accent-foreground transition-colors">
                        <i data-lucide="github" class="h-5 w-5"></i>
                        <span class="sr-only">GitHub</span>
                    </a>
                    <button id="mobileMenuBtn" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-accent hover:text-accent-foreground transition-colors md:hidden" aria-expanded="false" aria-controls="categoryMenu">
                        <i data-lucide="list" class="h-5 w-5"></i>
                        <span class="sr-only">分类菜单</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto max-w-6xl px-4 md:px-6 py-8 flex-1">
        <!-- Hero & Search -->
        <div class="flex flex-col items-center text-center gap-4 mb-10 animate-fade-in-up">
            <h1 class="text-3xl font-extrabold leading-tight tracking-tighter md:text-4xl">
                工具导航站
            </h1>
            <p class="max-w-[700px] text-lg text-muted-foreground">
                收集常用的开发工具与优质网站，提升工作效率。
            </p>
            
            <div class="w-full max-w-sm relative mt-4">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"></i>
                <input type="text" id="searchInput" placeholder="搜索网站..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pl-10 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
            </div>
        </div>

        <!-- Sites Container -->
        <div id="siteGrid" class="space-y-8">
             <!-- Skeleton Loading -->
             <div class="space-y-8 animate-pulse">
                 <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
                     <div class="h-20 rounded-xl bg-muted/50"></div>
                     <div class="h-20 rounded-xl bg-muted/50"></div>
                     <div class="h-20 rounded-xl bg-muted/50"></div>
                     <div class="h-20 rounded-xl bg-muted/50"></div>
                     <div class="h-20 rounded-xl bg-muted/50"></div>
                     <div class="h-20 rounded-xl bg-muted/50"></div>
                 </div>
             </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-center">
            <i data-lucide="inbox" class="h-12 w-12 text-muted-foreground mb-4"></i>
            <h3 class="text-lg font-semibold">没有找到相关网站</h3>
            <p class="text-muted-foreground">尝试更换搜索关键词</p>
        </div>
    </main>

    <!-- Floating Action Button Container -->
    <div id="fabContainer" class="fixed bottom-8 right-8 z-50 flex flex-col items-end hidden transition-opacity duration-300 pointer-events-none">
        
        <!-- Category Menu (Initially hidden) -->
        <div id="categoryMenu" class="pointer-events-auto mb-4 w-48 bg-card border border-border rounded-lg shadow-lg transform scale-90 opacity-0 invisible translate-y-4 transition-all duration-300 origin-bottom-right overflow-hidden flex flex-col max-h-[60vh]">
            <div class="px-4 py-3 border-b border-border/40 bg-transparent">
                <h3 class="font-medium text-sm text-muted-foreground">快速导航</h3>
            </div>
            <div id="categoryMenuList" class="overflow-y-auto py-1 custom-scrollbar">
                <!-- Categories will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const grid = document.getElementById('siteGrid');
        const searchInput = document.getElementById('searchInput');
        const emptyState = document.getElementById('emptyState');
        let allSites = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchSites();
        });

        async function fetchSites() {
            try {
                const response = await fetch('sites.txt');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const text = await response.text();
                parseSites(text);
            } catch (error) {
                console.error('Error fetching sites:', error);
                grid.innerHTML = `
                    <div class="col-span-full text-center text-destructive p-4 border border-destructive/20 rounded-lg bg-destructive/10">
                        <p class="font-bold">无法加载数据文件 (sites.txt)</p>
                        <p class="text-sm mt-1">请确保 sites.txt 存在且可通过 HTTP 访问 (由于浏览器安全策略，直接双击 HTML 可能无法读取本地文件)。</p>
                    </div>
                `;
            }
        }

        function parseSites(text) {
            allSites = [];
            let currentCategory = { name: '默认分类', sites: [] };

            const lines = text.split('\n').map(line => line.trim());

            lines.forEach(line => {
                if (!line) return;

                if (line.startsWith('##')) {
                    if (currentCategory.sites.length > 0) {
                        allSites.push(currentCategory);
                    }
                    const categoryName = line.replace(/^##\s*/, '').trim();
                    currentCategory = { name: categoryName, sites: [] };
                    return;
                }

                if (line.startsWith('#')) return;

                let parts = line.split(/,|\|/);
                if (parts.length < 2) {
                    const spaceIndex = line.indexOf(' ');
                    if (spaceIndex > -1) {
                        parts = [line.substring(0, spaceIndex), line.substring(spaceIndex + 1)];
                    } else {
                        return;
                    }
                }
                
                const name = parts[0].trim();
                let url = parts[1].trim();
                
                const isExternal = url.startsWith('http://') || url.startsWith('https://');
                const isRelative = url.startsWith('./') || url.startsWith('/') || (url.indexOf('/') !== -1 && url.indexOf(':') === -1) || url.indexOf('.') === -1;
                
                if (!isExternal && !isRelative) {
                    url = 'https://' + url;
                }

                currentCategory.sites.push({ name, url });
            });

            if (currentCategory.sites.length > 0) {
                allSites.push(currentCategory);
            }

            renderSites(allSites);
        }

        function generateAvatar(text) {
            const textColor = '#000000'; // Black text
            const letter = Array.from(text)[0] || '?';
            
            const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="64" height="64">
                <text x="50%" y="50%" dy=".35em" fill="${textColor}" font-family="Arial, sans-serif" font-size="32" font-weight="bold" text-anchor="middle">${letter}</text>
            </svg>`;
            
            return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
        }

        function handleFaviconError(img) {
            const domain = img.dataset.domain;
            const name = img.dataset.name;
            const retryCount = parseInt(img.dataset.retry || '0');
            
            // Fallback chain: Google -> DuckDuckGo -> Unavatar -> Local SVG
            const fallbacks = [
                `https://icons.duckduckgo.com/ip3/${domain}.ico`,
                `https://unavatar.io/${domain}`
            ];

            if (retryCount < fallbacks.length) {
                img.src = fallbacks[retryCount];
                img.dataset.retry = retryCount + 1;
            } else {
                img.removeAttribute('onerror');
                img.src = generateAvatar(name);
                img.classList.remove('h-5', 'w-5', 'object-contain');
                img.classList.add('h-full', 'w-full', 'object-cover');
            }
        }

        function renderSites(categories) {
            grid.innerHTML = '';
            const hasData = categories.some(cat => cat.sites && cat.sites.length > 0) || (Array.isArray(categories) && categories.length > 0 && !categories[0].sites);
            
            if (!hasData) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                renderFloatingMenu([]);
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            let dataToRender = categories;
            
            if (Array.isArray(categories) && categories.length > 0 && !categories[0].sites) {
                 dataToRender = [{ name: '搜索结果', sites: categories }];
            }

            const fragment = document.createDocumentFragment();
            const activeCategories = [];

            dataToRender.forEach((category, index) => {
                if (!category.sites || category.sites.length === 0) return;

                const categorySection = document.createElement('section');
                categorySection.className = 'w-full scroll-mt-24';
                
                const sectionId = `cat-${index}`;
                categorySection.id = sectionId;
                
                if (category.name !== '默认分类' && category.name !== '搜索结果') {
                     activeCategories.push({ name: category.name, id: sectionId });
                } else if (dataToRender.length > 1) {
                     activeCategories.push({ name: category.name, id: sectionId });
                }

                if (category.name !== '默认分类' && category.name !== '搜索结果') {
                     categorySection.innerHTML = `<h2 class="text-sm font-medium text-muted-foreground mt-0 mb-4 tracking-wider">${category.name}</h2>`;
                } else if (dataToRender.length > 1) {
                     categorySection.innerHTML = `<h2 class="text-sm font-medium text-muted-foreground mt-0 mb-4 tracking-wider">${category.name}</h2>`;
                }

                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3';

                category.sites.forEach(site => {
                    const card = createCard(site);
                    cardsContainer.appendChild(card);
                });

                categorySection.appendChild(cardsContainer);
                fragment.appendChild(categorySection);
            });
            
            grid.appendChild(fragment);
            
            lucide.createIcons();
            renderFloatingMenu(activeCategories);
        }

        function createCard(site) {
             const isExternal = site.url.startsWith('http');
             
             let displayUrl = '';
             let iconHtml = '';
             
             const avatarUrl = generateAvatar(site.name);
             
             if (isExternal) {
                 try {
                    displayUrl = new URL(site.url).hostname;
                } catch (e) {
                    displayUrl = site.url;
                }
                const faviconUrl = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(site.url)}&sz=64`;
                
                iconHtml = `
                    <img src="${faviconUrl}" 
                         data-domain="${displayUrl}" 
                          data-name="${site.name}"
                          alt="${site.name}" 
                          loading="lazy" 
                          class="h-5 w-5 object-contain transition-transform duration-500 group-hover:scale-110" 
                          onerror="handleFaviconError(this)">
                 `;
             } else {
                 displayUrl = site.url;
                 iconHtml = `<img src="${avatarUrl}" alt="${site.name}" loading="lazy" class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110">`;
             }

             const card = document.createElement('a');
            card.dataset.tooltip = site.name;
            card.href = site.url;
            card.target = isExternal ? "_blank" : "_self";
            card.className = "group relative flex items-center gap-3 p-3 rounded-xl border border-border bg-card text-card-foreground shadow-sm transition-all duration-300 hover:shadow-md hover:border-primary/50 no-underline select-none text-left " +
                             "before:content-[attr(data-tooltip)] before:absolute before:bottom-full before:left-1/2 before:-translate-x-1/2 before:mb-2 before:px-3 before:py-1.5 before:bg-popover before:text-popover-foreground before:text-sm before:rounded-md before:shadow-lg before:whitespace-nowrap before:opacity-0 hover:before:opacity-100 before:transition-opacity before:duration-200 before:pointer-events-none before:z-[60]";
             
             card.innerHTML = `
                 <div class="h-10 w-10 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden border border-border/50">
                     ${iconHtml}
                 </div>
                 <div class="flex flex-col min-w-0 flex-1">
                     <span class="text-sm font-semibold truncate text-foreground/90 group-hover:text-primary transition-colors">${site.name}</span>
                     <span class="text-xs text-muted-foreground truncate opacity-70">${displayUrl}</span>
                 </div>
             `;
             return card;
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        searchInput.addEventListener('input', debounce((e) => {
            const query = e.target.value.trim().toLowerCase();
            
            if (!query) {
                renderSites(allSites);
                return;
            }
            
            let filteredSites = [];
            allSites.forEach(cat => {
                const matched = cat.sites.filter(site => 
                    site.name.toLowerCase().includes(query) || 
                    site.url.toLowerCase().includes(query)
                );
                filteredSites = filteredSites.concat(matched);
            });
            
            renderSites(filteredSites);
        }, 500));

        // Floating Menu Logic
        const fabContainer = document.getElementById('fabContainer');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const categoryMenu = document.getElementById('categoryMenu');
        const categoryMenuList = document.getElementById('categoryMenuList');
        let isMenuOpen = false;

        mobileMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(); });
        document.addEventListener('click', (e) => {
            if (isMenuOpen && !categoryMenu.contains(e.target) && !mobileMenuBtn?.contains(e.target)) closeMenu();
        });

        function toggleMenu(show) {
            isMenuOpen = show !== undefined ? show : !isMenuOpen;
            const classes = ['scale-100', 'opacity-100', 'visible', 'translate-y-0'];

            if (isMenuOpen) {
                categoryMenu.classList.remove('scale-90', 'opacity-0', 'invisible', 'translate-y-4');
                categoryMenu.classList.add(...classes);
            } else {
                categoryMenu.classList.add('scale-90', 'opacity-0', 'invisible', 'translate-y-4');
                categoryMenu.classList.remove(...classes);
            }
            mobileMenuBtn?.setAttribute('aria-expanded', String(isMenuOpen));
        }
        const closeMenu = () => toggleMenu(false);

        function renderFloatingMenu(categories) {
            if (!categories?.length) return fabContainer.classList.add('hidden');
            fabContainer.classList.remove('hidden');

            const itemClass = 'nav-item group flex w-full items-center rounded-md border border-transparent px-4 py-2 hover:bg-muted hover:text-foreground text-muted-foreground transition-all relative truncate select-none';
            
            categoryMenuList.innerHTML = categories.map(cat => 
                `<div class="${itemClass}" onclick="scrollToSection('${cat.id}')">${cat.name}</div>`
            ).join('') + (categories.length > 3 ? `
                <div class="h-px bg-border/50 my-1 mx-2"></div>
                <div class="px-4 py-2 text-xs text-muted-foreground hover:text-foreground cursor-pointer text-center transition-colors" onclick="scrollToSection()">
                    <span class="flex items-center justify-center gap-1"><i data-lucide="arrow-up" class="h-3 w-3"></i> 回到顶部</span>
                </div>` : '');
            
            lucide.createIcons({ root: categoryMenuList });
        }

        function scrollToSection(id) {
            const top = id ? document.getElementById(id)?.getBoundingClientRect().top + window.pageYOffset - 80 : 0;
            window.scrollTo({ top, behavior: 'smooth' });
            closeMenu();
        }
    </script>
</body>
</html>
